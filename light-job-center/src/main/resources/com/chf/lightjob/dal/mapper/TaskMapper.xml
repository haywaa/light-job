<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chf.lightjob.dal.mapper.TaskMapper">
  <resultMap id="BaseResultMap" type="com.chf.lightjob.dal.entity.TaskDO">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
    -->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="status" jdbcType="TINYINT" property="status" />
    <result column="job_group" jdbcType="VARCHAR" property="jobGroup" />
    <result column="job_type" jdbcType="VARCHAR" property="jobType" />
    <result column="biz_key" jdbcType="VARCHAR" property="bizKey" />
    <result column="plan_trigger_time" jdbcType="TIMESTAMP" property="planTriggerTime" />
    <result column="expire_time" jdbcType="TIMESTAMP" property="expireTime" />
    <result column="expire_trigger_time" jdbcType="TIMESTAMP" property="expireTriggerTime" />
    <result column="block_strategy" jdbcType="VARCHAR" property="blockStrategy" />
    <result column="executor_address" jdbcType="VARCHAR" property="executorAddress" />
    <result column="executor_handler" jdbcType="VARCHAR" property="executorHandler" />
    <result column="executor_param" jdbcType="VARCHAR" property="executorParam" />
    <result column="executor_timeout" jdbcType="INTEGER" property="executorTimeout" />
    <result column="executor_fail_retry_count" jdbcType="INTEGER" property="executorFailRetryCount" />
    <result column="max_retry_times" jdbcType="VARCHAR" property="maxRetryTimes" />
    <result column="from_job_id" jdbcType="BIGINT" property="fromJobId" />
    <result column="trigger_time" jdbcType="TIMESTAMP" property="triggerTime" />
    <result column="trigger_index" jdbcType="INTEGER" property="triggerIndex" />
    <result column="failure_times" jdbcType="INTEGER" property="failureTimes" />
    <result column="finish_time" jdbcType="TIMESTAMP" property="finishTime" />
    <result column="trigger_log" jdbcType="LONGVARCHAR" property="triggerLog" />
  </resultMap>

  <select id="findAllTaskPlanTime" resultType="com.chf.lightjob.dal.entity.TaskScheduleInfo">
    SELECT from_job_id AS fromJobId, plan_trigger_time AS planTriggerTime
    FROM task
    WHERE biz_key = #{bizKey}
  </select>

  <select id="findAllTaskByBizKey" resultMap="BaseResultMap">
    SELECT * FROM task WHERE biz_key = #{bizKey}
  </select>

  <insert id="batchAdd">
    INSERT INTO task(
       `status`
      ,`job_group`
      ,`job_type`
      ,`biz_key`
      ,`plan_trigger_time`
      ,`expire_time`
      ,`executor_address`
      ,`executor_handler`
      ,`executor_param`
      ,`executor_timeout`
      ,`executor_fail_retry_count`
      ,`retry_duration`
      ,`from_job_id`
      ,`trigger_time`
      ,`trigger_index`
      ,`failure_times`
      ,`finish_time`
      ,`trigger_log`
    ) VALUES
    <foreach close=")" collection="list" item="item" open="(" separator="),(">
      #{item.status}
      ,#{item.jobGroup}
      ,#{item.jobType}
      ,#{item.bizKey}
      ,#{item.planTriggerTime}
      ,#{item.expireTime}
      ,#{item.executorAddress}
      ,#{item.executorHandler}
      ,#{item.executorParam}
      ,#{item.executorTimeout}
      ,#{item.executorFailRetryCount}
      ,#{item.retryDuration}
      ,#{item.fromJobId}
      ,#{item.triggerTime}
      ,#{item.triggerIndex}
      ,#{item.failureTimes}
      ,#{item.finishTime}
      ,#{item.triggerLog}
    </foreach>
  </insert>

  <select id="selectFirstUnfinishedTaskForJob" resultMap="BaseResultMap">
    SELECT * FROM task WHERE id = (SELECT min(id) FROM task WHERE job_type=#{jobType} AND from_job_id = #{fromJobId} AND status != 2 AND status != 4)
  </select>
</mapper>